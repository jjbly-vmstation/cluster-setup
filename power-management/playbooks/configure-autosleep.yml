---
# configure-autosleep.yml - Configure auto-sleep functionality
# Part of VMStation Power Management
#
# This playbook configures automatic sleep mode for idle nodes:
# - Deploy monitoring daemon
# - Configure inactivity detection
# - Set up grace periods and notifications
# - Enable whitelist/blacklist for pods
#
# Usage:
#   ansible-playbook -i /srv/vmstation-org/cluster-setup/ansible/inventory/hosts.yml power-management/playbooks/configure-autosleep.yml

- name: Configure Auto-Sleep
  hosts: sleepable
  become: true
  gather_facts: true

  vars:
    # Timeout and intervals (in minutes)
    inactivity_timeout: "{{ autosleep_timeout_minutes | default(120) }}"
    check_interval: "{{ autosleep_check_interval_minutes | default(5) }}"
    grace_period: "{{ autosleep_grace_period_minutes | default(10) }}"

    # Directories
    autosleep_config_dir: /etc/vmstation/autosleep
    autosleep_scripts_dir: /opt/vmstation/autosleep
    autosleep_state_dir: /var/lib/vmstation/autosleep
    autosleep_log_dir: /var/log/vmstation

    # Namespaces to exclude from activity check
    excluded_namespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - monitoring
      - logging

    # Labels that prevent sleep
    prevent_sleep_labels:
      - "vmstation.io/prevent-sleep=true"
      - "app.kubernetes.io/always-on=true"

    # Activity checks to perform
    activity_checks:
      - type: pods
        enabled: true
        description: "Check for running non-system pods"
      - type: cpu
        enabled: true
        threshold: 10  # percent
        description: "Check CPU usage"
      - type: network
        enabled: true
        threshold: 1024  # bytes/sec
        description: "Check network activity"
      - type: ssh
        enabled: true
        description: "Check for SSH sessions"

    # Notification settings
    notify_before_sleep: true
    notify_minutes_before: 5
    notification_method: log  # log, webhook, slack
    notification_webhook_url: ""

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart autosleep daemon
      ansible.builtin.systemd:
        name: vmstation-autosleep.service
        state: restarted
        enabled: true

  tasks:
    - name: Display autosleep configuration
      ansible.builtin.debug:
        msg: |
          Configuring auto-sleep for {{ inventory_hostname }}
          Inactivity timeout: {{ inactivity_timeout }} minutes
          Check interval: {{ check_interval }} minutes
          Grace period: {{ grace_period }} minutes

    # Create directories
    - name: Create autosleep directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ autosleep_config_dir }}"
        - "{{ autosleep_scripts_dir }}"
        - "{{ autosleep_state_dir }}"
        - "{{ autosleep_log_dir }}"
      tags:
        - directories

    # Deploy configuration
    - name: Deploy autosleep configuration
      ansible.builtin.copy:
        content: |
          # VMStation Auto-Sleep Configuration
          # Node: {{ inventory_hostname }}
          # Generated: {{ ansible_date_time.iso8601 }}

          [general]
          enabled=true
          inactivity_timeout_minutes={{ inactivity_timeout }}
          check_interval_minutes={{ check_interval }}
          grace_period_minutes={{ grace_period }}

          [activity_detection]
          check_pods=true
          check_cpu=true
          cpu_threshold_percent=10
          check_network=true
          network_threshold_bytes=1024
          check_ssh_sessions=true

          [excluded_namespaces]
          {% for ns in excluded_namespaces %}
          {{ ns }}
          {% endfor %}

          [prevent_sleep_labels]
          {% for label in prevent_sleep_labels %}
          {{ label }}
          {% endfor %}

          [notification]
          enabled={{ notify_before_sleep }}
          minutes_before={{ notify_minutes_before }}
          method={{ notification_method }}
          webhook_url={{ notification_webhook_url }}

          [logging]
          log_dir={{ autosleep_log_dir }}
          log_level=INFO
        dest: "{{ autosleep_config_dir }}/autosleep.conf"
        owner: root
        group: root
        mode: "0644"
      notify: Restart autosleep daemon
      tags:
        - config

    # Deploy monitoring script
    - name: Deploy autosleep monitor script
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          # VMStation Auto-Sleep Monitor
          # Monitors node activity and initiates sleep when idle

          set -euo pipefail

          # Configuration
          CONFIG_FILE="{{ autosleep_config_dir }}/autosleep.conf"
          STATE_FILE="{{ autosleep_state_dir }}/state"
          LOG_FILE="{{ autosleep_log_dir }}/autosleep.log"

          # Read configuration
          INACTIVITY_TIMEOUT={{ inactivity_timeout }}
          CHECK_INTERVAL={{ check_interval }}
          GRACE_PERIOD={{ grace_period }}
          CPU_THRESHOLD=10
          NETWORK_THRESHOLD=1024

          # Logging
          log() {
              echo "[$(date -Iseconds)] $1" | tee -a "$LOG_FILE"
          }

          # Initialize state
          init_state() {
              if [[ ! -f "$STATE_FILE" ]]; then
                  echo "LAST_ACTIVITY=$(date +%s)" > "$STATE_FILE"
                  echo "SLEEP_PENDING=false" >> "$STATE_FILE"
                  echo "SLEEP_ENABLED=true" >> "$STATE_FILE"
              fi
          }

          # Load state
          load_state() {
              source "$STATE_FILE"
          }

          # Save state
          save_state() {
              cat > "$STATE_FILE" << EOF
          LAST_ACTIVITY=$LAST_ACTIVITY
          SLEEP_PENDING=$SLEEP_PENDING
          SLEEP_ENABLED=$SLEEP_ENABLED
          EOF
          }

          # Update last activity timestamp
          update_activity() {
              LAST_ACTIVITY=$(date +%s)
              SLEEP_PENDING=false
              save_state
              log "Activity detected, reset idle timer"
          }

          # Check for running pods (excluding system namespaces)
          check_pods() {
              if ! command -v kubectl &>/dev/null; then
                  return 1  # Assume activity if kubectl not available
              fi

              local excluded_ns_filter=""
              {% for ns in excluded_namespaces %}
              excluded_ns_filter+=" -n {{ ns }}"
              {% endfor %}

              local running_pods
              running_pods=$(kubectl get pods --all-namespaces --field-selector=status.phase=Running -o json 2>/dev/null | \
                  jq -r '.items[] | select(.metadata.namespace | IN({{ excluded_namespaces | map("\"" + . + "\"") | join(",") }}) | not) | .metadata.name' 2>/dev/null | wc -l)

              if [[ "$running_pods" -gt 0 ]]; then
                  log "Found $running_pods running pods"
                  return 0
              fi
              return 1
          }

          # Check CPU usage
          check_cpu() {
              local cpu_usage
              cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 | cut -d'.' -f1)

              if [[ "$cpu_usage" -gt "$CPU_THRESHOLD" ]]; then
                  log "CPU usage ${cpu_usage}% above threshold ${CPU_THRESHOLD}%"
                  return 0
              fi
              return 1
          }

          # Check network activity
          check_network() {
              local rx_bytes_1 tx_bytes_1 rx_bytes_2 tx_bytes_2

              rx_bytes_1=$(cat /sys/class/net/{{ ansible_default_ipv4.interface | default('eth0') }}/statistics/rx_bytes 2>/dev/null || echo 0)
              tx_bytes_1=$(cat /sys/class/net/{{ ansible_default_ipv4.interface | default('eth0') }}/statistics/tx_bytes 2>/dev/null || echo 0)

              sleep 1

              rx_bytes_2=$(cat /sys/class/net/{{ ansible_default_ipv4.interface | default('eth0') }}/statistics/rx_bytes 2>/dev/null || echo 0)
              tx_bytes_2=$(cat /sys/class/net/{{ ansible_default_ipv4.interface | default('eth0') }}/statistics/tx_bytes 2>/dev/null || echo 0)

              local total_bytes=$(( (rx_bytes_2 - rx_bytes_1) + (tx_bytes_2 - tx_bytes_1) ))

              if [[ "$total_bytes" -gt "$NETWORK_THRESHOLD" ]]; then
                  log "Network activity ${total_bytes} bytes/sec above threshold"
                  return 0
              fi
              return 1
          }

          # Check SSH sessions
          check_ssh() {
              local ssh_sessions
              ssh_sessions=$(who | grep -c pts/ 2>/dev/null || echo 0)

              if [[ "$ssh_sessions" -gt 0 ]]; then
                  log "Found $ssh_sessions active SSH sessions"
                  return 0
              fi
              return 1
          }

          # Check all activity indicators
          check_activity() {
              if check_pods; then return 0; fi
              if check_cpu; then return 0; fi
              if check_network; then return 0; fi
              if check_ssh; then return 0; fi
              return 1
          }

          # Send notification
          send_notification() {
              local message="$1"
              log "NOTIFICATION: $message"

              {% if notification_webhook_url %}
              curl -s -X POST "{{ notification_webhook_url }}" \
                  -H "Content-Type: application/json" \
                  -d "{\"text\": \"$message\", \"node\": \"{{ inventory_hostname }}\"}" || true
              {% endif %}
          }

          # Initiate sleep
          initiate_sleep() {
              log "Initiating sleep sequence..."

              # Send notification
              send_notification "{{ inventory_hostname }} is going to sleep due to inactivity"

              # Run pre-sleep hooks
              if [[ -d "{{ autosleep_scripts_dir }}/pre-sleep.d" ]]; then
                  for script in "{{ autosleep_scripts_dir }}/pre-sleep.d"/*; do
                      if [[ -x "$script" ]]; then
                          log "Running pre-sleep script: $script"
                          "$script" || true
                      fi
                  done
              fi

              # Actually sleep (suspend to RAM)
              log "Suspending to RAM..."
              systemctl suspend
          }

          # Main monitoring loop
          main() {
              log "Starting VMStation auto-sleep monitor"
              log "Configuration: timeout=${INACTIVITY_TIMEOUT}min, interval=${CHECK_INTERVAL}min, grace=${GRACE_PERIOD}min"

              init_state

              while true; do
                  load_state

                  if [[ "$SLEEP_ENABLED" != "true" ]]; then
                      log "Auto-sleep disabled, skipping check"
                      sleep $((CHECK_INTERVAL * 60))
                      continue
                  fi

                  if check_activity; then
                      update_activity
                  else
                      local current_time=$(date +%s)
                      local idle_seconds=$((current_time - LAST_ACTIVITY))
                      local idle_minutes=$((idle_seconds / 60))
                      local timeout_seconds=$((INACTIVITY_TIMEOUT * 60))
                      local grace_seconds=$((GRACE_PERIOD * 60))

                      log "Node idle for ${idle_minutes} minutes (timeout: ${INACTIVITY_TIMEOUT} minutes)"

                      if [[ "$idle_seconds" -ge "$timeout_seconds" ]]; then
                          if [[ "$SLEEP_PENDING" != "true" ]]; then
                              SLEEP_PENDING=true
                              save_state
                              send_notification "{{ inventory_hostname }} will sleep in ${GRACE_PERIOD} minutes due to inactivity"
                              log "Sleep pending, grace period started"
                          elif [[ "$idle_seconds" -ge $((timeout_seconds + grace_seconds)) ]]; then
                              initiate_sleep
                          fi
                      fi
                  fi

                  sleep $((CHECK_INTERVAL * 60))
              done
          }

          # Handle signals
          trap 'log "Received signal, exiting..."; exit 0' SIGTERM SIGINT

          main "$@"
        dest: "{{ autosleep_scripts_dir }}/vmstation-autosleep-monitor.sh"
        owner: root
        group: root
        mode: "0755"
      notify: Restart autosleep daemon
      tags:
        - scripts

    # Deploy systemd service
    - name: Deploy autosleep service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=VMStation Auto-Sleep Monitor
          Documentation=https://github.com/jjbly-vmstation/cluster-setup
          After=network.target

          [Service]
          Type=simple
          ExecStart={{ autosleep_scripts_dir }}/vmstation-autosleep-monitor.sh
          ExecReload=/bin/kill -HUP $MAINPID
          Restart=always
          RestartSec=10

          # Security hardening
          NoNewPrivileges=yes
          ProtectSystem=strict
          ProtectHome=yes
          ReadWritePaths={{ autosleep_state_dir }} {{ autosleep_log_dir }}
          PrivateTmp=yes

          # Logging
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=vmstation-autosleep

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/vmstation-autosleep.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Restart autosleep daemon
      tags:
        - systemd

    # Create pre-sleep hooks directory
    - name: Create pre-sleep hooks directory
      ansible.builtin.file:
        path: "{{ autosleep_scripts_dir }}/pre-sleep.d"
        state: directory
        owner: root
        group: root
        mode: "0755"
      tags:
        - directories

    # Initialize state
    - name: Initialize autosleep state
      ansible.builtin.copy:
        content: |
          LAST_ACTIVITY={{ ansible_date_time.epoch }}
          SLEEP_PENDING=false
          SLEEP_ENABLED=true
        dest: "{{ autosleep_state_dir }}/state"
        owner: root
        group: root
        mode: "0644"
        force: false
      tags:
        - state

    # Enable and start service
    - name: Enable and start autosleep service
      ansible.builtin.systemd:
        name: vmstation-autosleep.service
        state: started
        enabled: true
        daemon_reload: true
      tags:
        - systemd

    # Create control scripts
    - name: Create autosleep control script
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          # VMStation Auto-Sleep Control

          STATE_FILE="{{ autosleep_state_dir }}/state"

          case "${1:-status}" in
              enable)
                  sed -i 's/SLEEP_ENABLED=.*/SLEEP_ENABLED=true/' "$STATE_FILE"
                  echo "Auto-sleep enabled"
                  ;;
              disable)
                  sed -i 's/SLEEP_ENABLED=.*/SLEEP_ENABLED=false/' "$STATE_FILE"
                  echo "Auto-sleep disabled"
                  ;;
              status)
                  source "$STATE_FILE"
                  echo "Auto-sleep enabled: $SLEEP_ENABLED"
                  echo "Sleep pending: $SLEEP_PENDING"
                  echo "Last activity: $(date -d @$LAST_ACTIVITY)"
                  ;;
              reset)
                  sed -i "s/LAST_ACTIVITY=.*/LAST_ACTIVITY=$(date +%s)/" "$STATE_FILE"
                  sed -i 's/SLEEP_PENDING=.*/SLEEP_PENDING=false/' "$STATE_FILE"
                  echo "Activity timer reset"
                  ;;
              *)
                  echo "Usage: $0 {enable|disable|status|reset}"
                  exit 1
                  ;;
          esac
        dest: /usr/local/bin/vmstation-autosleep-ctl
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts

  post_tasks:
    - name: Display autosleep summary
      ansible.builtin.debug:
        msg: |
          Auto-sleep configured for {{ inventory_hostname }}

          Settings:
            Inactivity timeout: {{ inactivity_timeout }} minutes
            Check interval: {{ check_interval }} minutes
            Grace period: {{ grace_period }} minutes

          Service: vmstation-autosleep.service
          Config: {{ autosleep_config_dir }}/autosleep.conf

          Control commands:
            vmstation-autosleep-ctl status   # Check status
            vmstation-autosleep-ctl disable  # Disable auto-sleep
            vmstation-autosleep-ctl enable   # Enable auto-sleep
            vmstation-autosleep-ctl reset    # Reset activity timer

          Logs: journalctl -u vmstation-autosleep.service
