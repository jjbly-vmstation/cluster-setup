---
# initial-setup.yml - Initial cluster setup playbook
# Part of VMStation Cluster Setup
#
# This playbook performs initial setup on all cluster nodes including:
# - System updates and package installation
# - Time synchronization configuration
# - Hostname and hosts file configuration
# - User and SSH configuration
# - Basic security hardening
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/initial-setup.yml
#   ansible-playbook -i inventory/hosts.yml playbooks/initial-setup.yml --check  # Dry run
#   ansible-playbook -i inventory/hosts.yml playbooks/initial-setup.yml --tags=packages

- name: Initial Cluster Setup
  hosts: all
  become: true
  gather_facts: true
  
  vars:
    # Default packages to install
    common_packages:
      - curl
      - wget
      - vim
      - git
      - htop
      - iotop
      - net-tools
      - dnsutils
      - jq
      - ca-certificates
      - gnupg
      - lsb-release
      - python3
      - python3-pip
      
    # NTP servers
    ntp_servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
      - 2.pool.ntp.org
      - 3.pool.ntp.org
      
    # Sysctl settings for Kubernetes
    sysctl_settings:
      net.bridge.bridge-nf-call-iptables: 1
      net.bridge.bridge-nf-call-ip6tables: 1
      net.ipv4.ip_forward: 1
      net.ipv4.conf.all.forwarding: 1
      vm.swappiness: 0
      
  handlers:
    - name: Restart chronyd
      ansible.builtin.systemd:
        name: chronyd
        state: restarted
        enabled: true
      when: ansible_os_family == "RedHat"

    - name: Restart systemd-timesyncd
      ansible.builtin.systemd:
        name: systemd-timesyncd
        state: restarted
        enabled: true
      when: ansible_os_family == "Debian"

    - name: Apply sysctl
      ansible.builtin.command: sysctl --system
      changed_when: true

    - name: Restart sshd
      ansible.builtin.systemd:
        name: sshd
        state: reloaded

  pre_tasks:
    - name: Display target hosts
      ansible.builtin.debug:
        msg: "Setting up node: {{ inventory_hostname }} ({{ ansible_host }})"
        
    - name: Validate connectivity
      ansible.builtin.ping:

  tasks:
    # System updates
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      tags:
        - packages
        - update
        
    - name: Update all packages (Debian/Ubuntu)
      ansible.builtin.apt:
        upgrade: safe
      when: ansible_os_family == "Debian"
      tags:
        - packages
        - update
        
    - name: Update all packages (RedHat/CentOS)
      ansible.builtin.yum:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"
      tags:
        - packages
        - update

    # Install common packages
    - name: Install common packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name: "{{ common_packages }}"
        state: present
      when: ansible_os_family == "Debian"
      tags:
        - packages
        
    - name: Install common packages (RedHat/CentOS)
      ansible.builtin.yum:
        name: "{{ common_packages }}"
        state: present
      when: ansible_os_family == "RedHat"
      tags:
        - packages

    # Hostname configuration
    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
      tags:
        - hostname
        
    - name: Update /etc/hosts with cluster nodes
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: ".*{{ hostvars[item]['inventory_hostname'] }}$"
        line: "{{ hostvars[item]['ansible_host'] }} {{ hostvars[item]['inventory_hostname'] }}"
        state: present
      loop: "{{ groups['all'] }}"
      tags:
        - hostname

    # Time synchronization
    - name: Install chrony (RedHat/CentOS)
      ansible.builtin.yum:
        name: chrony
        state: present
      when: ansible_os_family == "RedHat"
      tags:
        - time
        
    - name: Configure chrony
      ansible.builtin.template:
        src: chrony.conf.j2
        dest: /etc/chrony.conf
        owner: root
        group: root
        mode: "0644"
      when: ansible_os_family == "RedHat"
      notify: Restart chronyd
      tags:
        - time
        
    - name: Enable systemd-timesyncd (Debian/Ubuntu)
      ansible.builtin.systemd:
        name: systemd-timesyncd
        state: started
        enabled: true
      when: ansible_os_family == "Debian"
      tags:
        - time
        
    - name: Set timezone
      community.general.timezone:
        name: "{{ timezone | default('UTC') }}"
      tags:
        - time

    # Disable swap (required for Kubernetes)
    - name: Disable swap immediately
      ansible.builtin.command: swapoff -a
      when: ansible_swaptotal_mb > 0
      changed_when: true
      tags:
        - swap
        
    - name: Remove swap from fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: ".*swap.*"
        state: absent
      tags:
        - swap

    # Kernel modules
    - name: Load required kernel modules
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay
        - ip_vs
        - ip_vs_rr
        - ip_vs_wrr
        - ip_vs_sh
      tags:
        - kernel
        
    - name: Ensure kernel modules load on boot
      ansible.builtin.lineinfile:
        path: /etc/modules-load.d/kubernetes.conf
        line: "{{ item }}"
        create: true
        mode: "0644"
      loop:
        - br_netfilter
        - overlay
        - ip_vs
        - ip_vs_rr
        - ip_vs_wrr
        - ip_vs_sh
      tags:
        - kernel

    # Sysctl configuration
    - name: Configure sysctl for Kubernetes
      ansible.posix.sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-kubernetes.conf
        reload: true
      loop: "{{ sysctl_settings | dict2items }}"
      tags:
        - sysctl
        - kernel

    # SSH configuration
    - name: Configure SSH to allow root login with key
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PermitRootLogin"
        line: "PermitRootLogin prohibit-password"
        state: present
      notify: Restart sshd
      tags:
        - ssh
        
    - name: Disable SSH password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication no"
        state: present
      notify: Restart sshd
      tags:
        - ssh

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: "Initial setup complete for {{ inventory_hostname }}"
