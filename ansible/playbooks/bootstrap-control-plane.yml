---
# Playbook: bootstrap-control-plane.yml
# Purpose: copy pre-generated certs to control-plane hosts and optionally run kubeadm init

- name: Bootstrap control-plane using pre-generated certs
  hosts: masternode
  become: true
  vars:
    cert_source_dir: "/opt/vmstation-org/cluster-setup/scripts/certs"
    dest_dir: "/etc/kubernetes/pki"
    run_kubeadm_init: false
    kubeadm_config_file: ""

  tasks:
    - name: Ensure destination directory exists on control-plane
      file:
        path: "{{ dest_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0700'

    - name: Copy cert files to control-plane hosts
      synchronize:
        src: "{{ cert_source_dir }}/"
        dest: "{{ dest_dir }}/"
        rsync_opts:
          - "--chmod=600"

    - name: Set ownership and permissions on copied certs
      file:
        path: "{{ dest_dir }}"
        recurse: true
        owner: root
        group: root
        mode: '0600'

    - name: Optionally run kubeadm init
      when: run_kubeadm_init | bool
      block:
        - name: Run kubeadm init with config (if provided)
          command: >-
            kubeadm init {{ '--config ' + kubeadm_config_file if kubeadm_config_file else '' }}
          args:
            creates: /etc/kubernetes/admin.conf

        - name: Copy admin kubeconfig to local operator (optional)
          fetch:
            src: /etc/kubernetes/admin.conf
            dest: ./admin-{{ inventory_hostname }}.conf
            flat: yes

    - name: Debug - bootstrap complete on host
      debug:
        msg: "Certificates copied to {{ dest_dir }} on {{ inventory_hostname }}. kubeadm init run: {{ run_kubeadm_init }}"
