---
# Playbook: pre-generate-certs.yml
# Purpose: Run the local cert generation script and place artifacts in a predictable location.
- name: Pre-generate TLS certificates for Kubernetes bootstrap
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    cert_script_path: "{{ playbook_dir }}/../../scripts/generate_certs.sh"
    cert_output_dir: "{{ playbook_dir }}/../../scripts/certs"

  tasks:
    - name: Ensure cert output directory exists
      file:
        path: "{{ cert_output_dir }}"
        state: directory
        mode: '0755'

    - name: Run cert generation script
      command: "bash {{ cert_script_path }} -o {{ cert_output_dir }}"
      environment:
        PATH: "{{ ansible_env.PATH }}"

    - name: Show generated artifacts
      command: "ls -l {{ cert_output_dir }}"
      register: ls_out

    - name: Print artifacts list
      debug:
        msg: "{{ ls_out.stdout }}"

    - name: Create tarball of certs for optional distribution
      archive:
        path: "{{ cert_output_dir }}"
        dest: "{{ cert_output_dir }}.tar.gz"
        format: gz

    - name: Inform operator how to proceed
      debug:
        msg: |
          Certificates generated under {{ cert_output_dir }} and bundled to {{ cert_output_dir }}.tar.gz.
          Next steps: distribute to control-plane hosts or upload to your secret store (Vault/Kubernetes Secret).
