---
# setup-autosleep.yml - Configure auto-sleep monitoring for the cluster
# Part of VMStation Cluster Setup
#
# This playbook sets up automatic sleep mode for idle cluster nodes:
# - Deploys the autosleep monitoring script
# - Configures systemd service and timer
# - Sets up notification mechanisms
# - Configures pod activity detection
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/setup-autosleep.yml
#   ansible-playbook -i inventory/hosts.yml playbooks/setup-autosleep.yml -e autosleep_timeout_minutes=60

- name: Setup Auto-Sleep Monitoring
  hosts: sleepable
  become: true
  gather_facts: true

  vars:
    # Auto-sleep configuration
    autosleep_timeout_minutes: "{{ autosleep_timeout_minutes | default(120) }}"
    autosleep_check_interval_minutes: "{{ autosleep_check_interval_minutes | default(5) }}"
    autosleep_grace_period_minutes: "{{ autosleep_grace_period_minutes | default(10) }}"

    # Directory paths
    scripts_dir: /opt/vmstation/scripts
    config_dir: /etc/vmstation
    state_dir: /var/lib/vmstation
    log_dir: /var/log/vmstation

    # Namespaces to exclude from activity detection
    excluded_namespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - monitoring

    # Pod labels that prevent sleep
    prevent_sleep_labels:
      - "vmstation.io/prevent-sleep=true"
      - "app.kubernetes.io/prevent-sleep=true"

    # Notification settings
    notification_enabled: false
    notification_webhook_url: ""
    notification_slack_channel: ""

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart autosleep timer
      ansible.builtin.systemd:
        name: vmstation-autosleep.timer
        state: restarted
        enabled: true

    - name: Restart autosleep monitor
      ansible.builtin.systemd:
        name: vmstation-autosleep-monitor.service
        state: restarted
        enabled: true

  tasks:
    - name: Display setup information
      ansible.builtin.debug:
        msg: |
          Configuring auto-sleep for {{ inventory_hostname }}
          Timeout: {{ autosleep_timeout_minutes }} minutes
          Check interval: {{ autosleep_check_interval_minutes }} minutes
          Grace period: {{ autosleep_grace_period_minutes }} minutes

    # Create directories
    - name: Create VMStation directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ scripts_dir }}"
        - "{{ config_dir }}"
        - "{{ state_dir }}"
        - "{{ log_dir }}"
      tags:
        - directories

    # Deploy configuration
    - name: Deploy autosleep configuration
      ansible.builtin.template:
        src: autosleep.conf.j2
        dest: "{{ config_dir }}/autosleep.conf"
        owner: root
        group: root
        mode: "0644"
      notify: Restart autosleep monitor
      tags:
        - config

    # Deploy monitoring script
    - name: Deploy autosleep monitoring script
      ansible.builtin.copy:
        src: vmstation-autosleep-monitor.sh
        dest: "{{ scripts_dir }}/vmstation-autosleep-monitor.sh"
        owner: root
        group: root
        mode: "0755"
      notify: Restart autosleep monitor
      tags:
        - scripts

    # Deploy sleep script
    - name: Deploy sleep script
      ansible.builtin.copy:
        src: vmstation-sleep.sh
        dest: "{{ scripts_dir }}/vmstation-sleep.sh"
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts

    # Deploy systemd service for continuous monitoring
    - name: Deploy autosleep monitor service
      ansible.builtin.template:
        src: autosleep-monitor.service.j2
        dest: /etc/systemd/system/vmstation-autosleep-monitor.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Restart autosleep monitor
      tags:
        - systemd

    # Deploy systemd timer for periodic checks
    - name: Deploy autosleep timer
      ansible.builtin.template:
        src: autosleep-timer.timer.j2
        dest: /etc/systemd/system/vmstation-autosleep.timer
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Restart autosleep timer
      tags:
        - systemd

    # Deploy oneshot service for timer
    - name: Deploy autosleep oneshot service
      ansible.builtin.template:
        src: autosleep-check.service.j2
        dest: /etc/systemd/system/vmstation-autosleep-check.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
      tags:
        - systemd

    # Enable and start services
    - name: Enable and start autosleep monitor
      ansible.builtin.systemd:
        name: vmstation-autosleep-monitor.service
        state: started
        enabled: true
        daemon_reload: true
      tags:
        - systemd

    - name: Enable and start autosleep timer
      ansible.builtin.systemd:
        name: vmstation-autosleep.timer
        state: started
        enabled: true
        daemon_reload: true
      tags:
        - systemd

    # Create initial state file
    - name: Initialize autosleep state
      ansible.builtin.copy:
        content: |
          # VMStation Autosleep State
          # This file tracks the last activity timestamp
          LAST_ACTIVITY={{ ansible_date_time.epoch }}
          SLEEP_ENABLED=true
          SLEEP_PENDING=false
        dest: "{{ state_dir }}/autosleep.state"
        owner: root
        group: root
        mode: "0644"
        force: false
      tags:
        - state

    # Verify setup
    - name: Verify autosleep monitor is running
      ansible.builtin.systemd:
        name: vmstation-autosleep-monitor.service
      register: autosleep_service

    - name: Display service status
      ansible.builtin.debug:
        msg: "Autosleep monitor status: {{ autosleep_service.status.ActiveState }}"

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Auto-sleep monitoring configured for {{ inventory_hostname }}

          Services:
            - vmstation-autosleep-monitor.service (continuous monitoring)
            - vmstation-autosleep.timer (periodic checks)

          Configuration: {{ config_dir }}/autosleep.conf
          Logs: journalctl -u vmstation-autosleep-monitor.service

          To disable auto-sleep temporarily:
            systemctl stop vmstation-autosleep.timer

          To re-enable:
            systemctl start vmstation-autosleep.timer
