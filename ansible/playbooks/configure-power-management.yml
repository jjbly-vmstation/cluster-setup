---
# configure-power-management.yml - Configure power management for the cluster
# Part of VMStation Cluster Setup
#
# This playbook configures comprehensive power management including:
# - Wake-on-LAN settings
# - Power state monitoring
# - Sleep/wake coordination
# - Power consumption optimization
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/configure-power-management.yml

- name: Configure Power Management
  hosts: all
  become: true
  gather_facts: true
  
  vars:
    # Power management directories
    power_scripts_dir: /opt/vmstation/power
    power_config_dir: /etc/vmstation/power
    power_state_dir: /var/lib/vmstation/power
    
    # Wake-on-LAN settings
    wol_enabled: true
    wol_interface: "{{ ansible_default_ipv4.interface | default('eth0') }}"
    
    # Power state tracking
    power_state_file: /var/lib/vmstation/power/state
    
    # Shutdown behavior
    graceful_shutdown_timeout: 300
    drain_timeout: 120
    
    # Power profiles
    power_profiles:
      performance:
        cpu_governor: performance
        disk_power_management: false
        network_power_save: false
      balanced:
        cpu_governor: ondemand
        disk_power_management: true
        network_power_save: false
      powersave:
        cpu_governor: powersave
        disk_power_management: true
        network_power_save: true
        
    default_power_profile: balanced

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
        
    - name: Restart power manager
      ansible.builtin.systemd:
        name: vmstation-power-manager.service
        state: restarted
        enabled: true

  tasks:
    - name: Display power management configuration
      ansible.builtin.debug:
        msg: |
          Configuring power management for {{ inventory_hostname }}
          WoL Interface: {{ wol_interface }}
          Power Profile: {{ default_power_profile }}

    # Create directories
    - name: Create power management directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ power_scripts_dir }}"
        - "{{ power_config_dir }}"
        - "{{ power_state_dir }}"
      tags:
        - directories

    # Install required packages
    - name: Install power management packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - ethtool
          - wakeonlan
          - powertop
          - cpufrequtils
        state: present
      when: ansible_os_family == "Debian"
      tags:
        - packages

    - name: Install power management packages (RedHat/CentOS)
      ansible.builtin.yum:
        name:
          - ethtool
          - kernel-tools
        state: present
      when: ansible_os_family == "RedHat"
      tags:
        - packages

    # Configure Wake-on-LAN
    - name: Check current WoL status
      ansible.builtin.command: ethtool {{ wol_interface }}
      register: ethtool_output
      changed_when: false
      failed_when: false
      tags:
        - wol

    - name: Enable Wake-on-LAN
      ansible.builtin.command: "ethtool -s {{ wol_interface }} wol g"
      when: wol_enabled and ethtool_output.stdout is not search('Wake-on:\s*g')
      changed_when: true
      tags:
        - wol

    # Make WoL persistent
    - name: Create WoL persistence script
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          # Enable Wake-on-LAN on boot
          /usr/sbin/ethtool -s {{ wol_interface }} wol g
        dest: /etc/network/if-up.d/wol
        owner: root
        group: root
        mode: "0755"
      when: ansible_os_family == "Debian"
      tags:
        - wol

    - name: Create WoL systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Enable Wake-on-LAN
          After=network.target
          
          [Service]
          Type=oneshot
          ExecStart=/usr/sbin/ethtool -s {{ wol_interface }} wol g
          RemainAfterExit=yes
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/vmstation-wol.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd
      tags:
        - wol
        - systemd

    - name: Enable WoL service
      ansible.builtin.systemd:
        name: vmstation-wol.service
        state: started
        enabled: true
        daemon_reload: true
      tags:
        - wol
        - systemd

    # Store MAC address for WoL
    - name: Get MAC address
      ansible.builtin.set_fact:
        node_mac_address: "{{ ansible_facts[wol_interface]['macaddress'] }}"
      tags:
        - wol

    - name: Store MAC address for WoL
      ansible.builtin.copy:
        content: |
          # VMStation Node WoL Information
          # Node: {{ inventory_hostname }}
          # Generated: {{ ansible_date_time.iso8601 }}
          
          HOSTNAME={{ inventory_hostname }}
          IP_ADDRESS={{ ansible_host }}
          MAC_ADDRESS={{ node_mac_address }}
          INTERFACE={{ wol_interface }}
        dest: "{{ power_config_dir }}/wol.conf"
        owner: root
        group: root
        mode: "0644"
      tags:
        - wol
        - config

    # Deploy power management configuration
    - name: Deploy power management configuration
      ansible.builtin.copy:
        content: |
          # VMStation Power Management Configuration
          # Node: {{ inventory_hostname }}
          
          [general]
          enabled=true
          profile={{ default_power_profile }}
          
          [shutdown]
          graceful_timeout={{ graceful_shutdown_timeout }}
          drain_timeout={{ drain_timeout }}
          
          [wol]
          enabled={{ wol_enabled }}
          interface={{ wol_interface }}
          mac_address={{ node_mac_address }}
          
          [profiles]
          default={{ default_power_profile }}
        dest: "{{ power_config_dir }}/power.conf"
        owner: root
        group: root
        mode: "0644"
      tags:
        - config

    # Deploy power management scripts
    - name: Deploy wake script
      ansible.builtin.copy:
        src: vmstation-wake.sh
        dest: "{{ power_scripts_dir }}/vmstation-wake.sh"
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts

    - name: Deploy sleep script
      ansible.builtin.copy:
        src: vmstation-sleep.sh
        dest: "{{ power_scripts_dir }}/vmstation-sleep.sh"
        owner: root
        group: root
        mode: "0755"
      tags:
        - scripts

    # Set power profile
    - name: Check if CPU governor is available
      ansible.builtin.stat:
        path: /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
      register: cpu_governor_available
      tags:
        - power-profile

    - name: Set CPU governor
      ansible.builtin.copy:
        content: "{{ power_profiles[default_power_profile].cpu_governor }}"
        dest: /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
        mode: "0644"
      when: cpu_governor_available.stat.exists
      failed_when: false
      tags:
        - power-profile

    # Initialize power state
    - name: Initialize power state file
      ansible.builtin.copy:
        content: |
          # VMStation Power State
          # Node: {{ inventory_hostname }}
          STATE=running
          LAST_STATE_CHANGE={{ ansible_date_time.epoch }}
          BOOT_TIME={{ ansible_date_time.epoch }}
        dest: "{{ power_state_dir }}/state"
        owner: root
        group: root
        mode: "0644"
        force: false
      tags:
        - state

  post_tasks:
    - name: Display power management summary
      ansible.builtin.debug:
        msg: |
          Power management configured for {{ inventory_hostname }}
          
          Wake-on-LAN:
            Enabled: {{ wol_enabled }}
            Interface: {{ wol_interface }}
            MAC Address: {{ node_mac_address }}
            
          Power Profile: {{ default_power_profile }}
          
          Configuration: {{ power_config_dir }}/power.conf
          WoL Config: {{ power_config_dir }}/wol.conf
          
          To wake this node:
            wakeonlan {{ node_mac_address }}


# Collect WoL information from all nodes (run on control node)
- name: Collect WoL Information
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    wol_registry_file: /tmp/vmstation-wol-registry.conf
    
  tasks:
    - name: Create WoL registry
      ansible.builtin.copy:
        content: |
          # VMStation WoL Registry
          # Generated: {{ lookup('pipe', 'date -Iseconds') }}
          #
          # This file contains MAC addresses for all cluster nodes
          # Use with: wakeonlan -f {{ wol_registry_file }}
          
          {% for host in groups['all'] %}
          # {{ host }}
          {{ hostvars[host]['node_mac_address'] | default('unknown') }}
          {% endfor %}
        dest: "{{ wol_registry_file }}"
        mode: "0644"
      when: groups['all'] | length > 0
      
    - name: Display WoL registry location
      ansible.builtin.debug:
        msg: "WoL registry created at: {{ wol_registry_file }}"
